---
// src/pages/akun/wishlist.astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCurrentUser } from '../../lib/auth';
import { getAllProducts } from '../../lib/products';

// Cek otentikasi sebelum memuat halaman
let user = null;

try {
  user = await getCurrentUser();
  if (!user) {
    // Redirect ke halaman login jika tidak otentikasi
    return Astro.redirect('/akun/login?redirect=/akun/wishlist');
  }
} catch (error) {
  console.error('Error checking authentication:', error);
  return Astro.redirect('/akun/login?redirect=/akun/wishlist');
}

// Ambil semua produk dari database
let allProducts = [];
try {
  allProducts = await getAllProducts();
} catch (error) {
  console.error('Error fetching products:', error);
}

// Ambil wishlist user dari database
let wishlistItems = [];
try {
  const { data, error } = await supabase
    .from('wishlists')
    .select(`
      *,
      product:products(*, product_images(*))
    `)
    .eq('user_id', user.id);

  if (error) {
    throw error;
  }

  wishlistItems = data;
} catch (error) {
  console.error('Error fetching wishlist:', error);
}

// Hapus item dari wishlist jika ada permintaan POST
if (request.method === 'POST') {
  const formData = await request.formData();
  const productId = formData.get('product_id');
  
  try {
    // Hapus dari wishlist
    const { error } = await supabase
      .from('wishlists')
      .delete()
      .eq('user_id', user.id)
      .eq('product_id', productId);
    
    if (error) {
      throw error;
    }
    
    // Refresh wishlist setelah penghapusan
    const { data, error: fetchError } = await supabase
      .from('wishlists')
      .select(`
        *,
        product:products(*, product_images(*))
      `)
      .eq('user_id', user.id);

    if (fetchError) {
      throw fetchError;
    }

    wishlistItems = data;
  } catch (error) {
    console.error('Error removing from wishlist:', error);
  }
}
---

<Layout>
  <Header />
  
  <!-- Header Halaman -->
  <section class="bg-[var(--furniture-cream)] py-8 px-6">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold text-[var(--furniture-brown)]">Daftar Keinginan Saya</h1>
      <p class="text-gray-600 mt-2">Produk-produk yang Anda simpan untuk dibeli nanti</p>
    </div>
  </section>
  
  <main class="container mx-auto py-8 px-4">
    <!-- Navigasi Akun -->
    <div class="flex border-b border-gray-200 mb-8">
      <a href="/akun/profil" class="py-2 px-4 text-sm font-medium text-gray-500 hover:text-[var(--furniture-brown)]">Profil Saya</a>
      <a href="/akun/pesanan" class="py-2 px-4 text-sm font-medium text-gray-500 hover:text-[var(--furniture-brown)]">Riwayat Pesanan</a>
      <a href="/akun/wishlist" class="py-2 px-4 text-sm font-medium text-[var(--furniture-brown)] border-b-2 border-[var(--furniture-brown)]">Wishlist</a>
      <a href="/akun/keamanan" class="py-2 px-4 text-sm font-medium text-gray-500 hover:text-[var(--furniture-brown)]">Keamanan</a>
    </div>
    
    <!-- Daftar Wishlist -->
    <div>
      {wishlistItems.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {wishlistItems.map((item) => (
            <div key={item.id} class="product-card group flex flex-col md:flex-row">
              <div class="md:w-1/3">
                {item.product.product_images && item.product.product_images.length > 0 ? (
                  <img 
                    src={item.product.product_images[0].image_url} 
                    alt={item.product.name} 
                    class="w-full h-48 object-cover"
                  />
                ) : (
                  <div class="bg-gray-200 border-2 border-dashed w-full h-48 flex items-center justify-center text-gray-500">
                    Tidak ada gambar
                  </div>
                )}
              </div>
              <div class="p-4 md:w-2/3 flex flex-col">
                <h3 class="font-semibold text-lg mb-1">{item.product.name}</h3>
                <p class="text-gray-600 text-sm mb-3 flex-grow">{item.product.description}</p>
                <div class="flex justify-between items-center mt-auto">
                  <span class="text-lg font-bold text-[var(--furniture-brown)]">Rp {Number(item.product.price).toLocaleString('id-ID')}</span>
                  <div class="flex space-x-2">
                    <form method="post" class="inline">
                      <input type="hidden" name="product_id" value={item.product.id} />
                      <button 
                        type="submit" 
                        class="text-red-600 hover:text-red-800"
                        onclick="return confirm('Apakah Anda yakin ingin menghapus produk ini dari wishlist?')"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </form>
                    <button class="btn-primary text-sm" onclick="addToCart({item.product.id})">
                      Beli Sekarang
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
          <h3 class="text-xl font-medium text-gray-900 mb-2">Wishlist Anda Kosong</h3>
          <p class="text-gray-500 mb-6">Anda belum menambahkan produk ke dalam wishlist</p>
          <a href="/produk" class="btn-primary">Jelajahi Produk</a>
        </div>
      )}
    </div>
  </main>
  
  <Footer />
  
  <script>
    function addToCart(productId) {
      // Dalam implementasi nyata, Anda akan memanggil fungsi untuk menambahkan ke keranjang
      console.log('Menambahkan produk dengan ID:', productId, 'ke keranjang');
      alert('Produk telah ditambahkan ke keranjang (fungsi ini akan diimplementasikan nanti)');
    }
  </script>
</Layout>