---
// src/pages/admin/lookbook/edit/[id].astro
import { getLookbookGalleryById, updateLookbookGallery } from '../../../../lib/admin-api';
import Layout from '../../../../layouts/Layout.astro';

// Dapatkan ID dari URL
const id = Astro.params.id;

// Periksa otentikasi admin
const { data: { user } } = await supabase.auth.getUser();
if (!user) {
  return Response.redirect(new URL('/admin/login', request.url));
}

// Cek apakah user memiliki role admin
const { data: profileData } = await supabase
  .from('profiles')
  .select('id')
  .eq('id', user.id)
  .single();

if (!profileData) {
  return Response.redirect(new URL('/akun/login', request.url));
}

// Ambil data galeri
let gallery = null;
try {
  gallery = await getLookbookGalleryById(id);
} catch (error) {
  console.error('Error fetching lookbook gallery:', error);
}

// Proses form jika ada submit
if (request.method === 'POST') {
  const formData = await request.formData();
  const title = formData.get('title');
  const description = formData.get('description');
  const coverImage = formData.get('cover_image');

  try {
    await updateLookbookGallery(id, {
      title,
      description,
      cover_image_url: coverImage
    });
    
    return Response.redirect(new URL('/admin/lookbook', request.url));
  } catch (error) {
    console.error('Error updating lookbook gallery:', error);
  }
}
---

<Layout>
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Edit Gallery Lookbook</h1>
    
    {gallery ? (
      <form method="post" class="bg-white shadow-md rounded-lg p-6">
        <div class="mb-4">
          <label for="title" class="block text-gray-700 font-medium mb-2">Judul</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            value={gallery.title || ''}
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>

        <div class="mb-4">
          <label for="description" class="block text-gray-700 font-medium mb-2">Deskripsi</label>
          <textarea 
            id="description" 
            name="description" 
            rows="4"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >{gallery.description || ''}</textarea>
        </div>

        <div class="mb-4">
          <label for="cover_image" class="block text-gray-700 font-medium mb-2">URL Gambar Cover</label>
          <input 
            type="text" 
            id="cover_image" 
            name="cover_image" 
            value={gallery.cover_image_url || ''}
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>

        <div class="flex justify-end">
          <button 
            type="submit" 
            class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition"
          >
            Simpan Perubahan
          </button>
        </div>
      </form>
    ) : (
      <p>Gallery tidak ditemukan.</p>
    )}
  </div>
</Layout>